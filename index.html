<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mnow Stores Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: Arial, sans-serif; }
        body { background: #f5f7fa; padding: 20px; }
        .dashboard { max-width: 1200px; margin: 0 auto; }
        .header { background: white; padding: 20px; border-radius: 10px; margin-bottom: 20px; text-align: center; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .kpi-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; margin-bottom: 20px; }
        .kpi-card { background: white; padding: 20px; border-radius: 10px; text-align: center; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .chart-container { background: white; padding: 20px; border-radius: 10px; margin-bottom: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        table { width: 100%; border-collapse: collapse; background: white; border-radius: 10px; overflow: hidden; margin-top: 20px; }
        th, td { padding: 12px; text-align: center; border-bottom: 1px solid #ddd; }
        th { background: #2c3e50; color: white; }
        .progress-bar { background: #ecf0f1; height: 10px; border-radius: 5px; overflow: hidden; margin: 5px 0; }
        .progress-fill { height: 100%; transition: width 0.3s; }
        .loading { text-align: center; padding: 40px; color: #666; }
        .btn { background: #3498db; color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; margin: 5px; }
        .btn:hover { background: #2980b9; }
        .store-name { text-align: left; font-weight: bold; }
    </style>
</head>
<body>
    <div class="dashboard">
        <div class="header">
            <h1>üè™ Mnow Stores Performance Dashboard</h1>
            <p>Live data from Google Sheets</p>
            <button class="btn" onclick="loadData()">üîÑ Refresh Data</button>
            <span id="status"></span>
        </div>

        <div id="loading" class="loading">
            <h3>Loading data from Google Sheets...</h3>
        </div>

        <div id="content" style="display: none;">
            <div class="kpi-grid">
                <div class="kpi-card">
                    <h3>Total Attainment</h3>
                    <div class="kpi-value" id="totalAttainment">0</div>
                </div>
                <div class="kpi-card">
                    <h3>Attainment Rate</h3>
                    <div class="kpi-value" id="attainmentRate">0%</div>
                </div>
                <div class="kpi-card">
                    <h3>Vs Projection</h3>
                    <div class="kpi-value" id="vsProjection">0%</div>
                </div>
                <div class="kpi-card">
                    <h3>Vs Yesterday</h3>
                    <div class="kpi-value" id="vsYesterday">0%</div>
                </div>
            </div>

            <div class="chart-container">
                <h2>Overall Hourly Trend</h2>
                <canvas id="trendChart" height="80"></canvas>
            </div>

            <div class="chart-container">
                <h2>Store Performance</h2>
                <canvas id="performanceChart" height="80"></canvas>
            </div>

            <div class="chart-container">
                <h2>Store-wise Performance</h2>
                <table>
                    <thead>
                        <tr>
                            <th>Store</th><th>6AM</th><th>7AM</th><th>8AM</th><th>9AM</th><th>10AM</th>
                            <th>Total</th><th>Achievement</th>
                        </tr>
                    </thead>
                    <tbody id="storesTable">
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        // ‚ö†Ô∏è REPLACE THIS WITH YOUR ACTUAL WEB APP URL ‚ö†Ô∏è
        const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbyAx_Rh8hVXEQf804nNrPojhIHSZCrQfnDtWqxPrMNZ-swc8xIE2T___Q17buFMU7jz/exec';
        
        let storeData = {};

        async function loadData() {
            showLoading();
            document.getElementById('status').textContent = 'Loading...';
            
            try {
                const response = await fetch(WEB_APP_URL);
                const result = await response.json();
                
                if (result.success) {
                    storeData = result.data;
                    initializeDashboard();
                    document.getElementById('status').textContent = '‚úì Data loaded';
                } else {
                    throw new Error(result.error);
                }
            } catch (error) {
                console.error('Error:', error);
                document.getElementById('status').textContent = '‚úó Using sample data';
                // Use sample data
                loadSampleData();
                initializeDashboard();
            }
        }

        function loadSampleData() {
            storeData = {
                projection: {
                    "Janakpuri Mnow SF": {"6":4,"7":12,"8":20,"9":29,"10":33},
                    "UttamNagar Mnow SF": {"6":6,"7":19,"8":32,"9":46,"10":52},
                    "Dwarka Mnow SF": {"6":3,"7":9,"8":16,"9":23,"10":26},
                    "Mandawali Mnow SF": {"6":4,"7":11,"8":20,"9":28,"10":32}
                },
                attainment: {
                    "Janakpuri Mnow SF": {"6":5,"7":15,"8":22,"9":43,"10":37},
                    "UttamNagar Mnow SF": {"6":6,"7":17,"8":28,"9":46,"10":52},
                    "Dwarka Mnow SF": {"6":2,"7":9,"8":22,"9":29,"10":26},
                    "Mandawali Mnow SF": {"6":1,"7":4,"8":20,"9":33,"10":32}
                },
                yesterday: {
                    "Janakpuri Mnow SF": {"6":7,"7":14,"8":16,"9":45,"10":34},
                    "UttamNagar Mnow SF": {"6":2,"7":27,"8":28,"9":36,"10":56},
                    "Dwarka Mnow SF": {"6":2,"7":5,"8":16,"9":33,"10":29},
                    "Mandawali Mnow SF": {"6":2,"7":13,"8":20,"9":26,"10":39}
                }
            };
        }

        function initializeDashboard() {
            calculateKPIs();
            createCharts();
            populateTable();
            hideLoading();
        }

        function calculateKPIs() {
            let totalProjected = 0;
            let totalAttained = 0;
            let totalYesterday = 0;

            Object.keys(storeData.projection).forEach(store => {
                const projected = sumFirstNHours(storeData.projection[store], 5);
                const attained = sumFirstNHours(storeData.attainment[store], 5);
                const yesterday = sumFirstNHours(storeData.yesterday[store], 5);
                
                totalProjected += projected;
                totalAttained += attained;
                totalYesterday += yesterday;
            });

            const attainmentRate = ((totalAttained / totalProjected) * 100).toFixed(1);
            const vsProjection = ((totalAttained - totalProjected) / totalProjected * 100).toFixed(1);
            const vsYesterday = ((totalAttained - totalYesterday) / totalYesterday * 100).toFixed(1);

            document.getElementById('totalAttainment').textContent = totalAttained;
            document.getElementById('attainmentRate').textContent = attainmentRate + '%';
            document.getElementById('vsProjection').textContent = vsProjection + '%';
            document.getElementById('vsYesterday').textContent = vsYesterday + '%';
        }

        function sumFirstNHours(hoursObj, n) {
            let sum = 0;
            for (let i = 6; i < 6 + n; i++) {
                sum += hoursObj[i] || 0;
            }
            return sum;
        }

        function createCharts() {
            // Trend Chart
            const trendCtx = document.getElementById('trendChart').getContext('2d');
            new Chart(trendCtx, {
                type: 'line',
                data: {
                    labels: ['6AM', '7AM', '8AM', '9AM', '10AM'],
                    datasets: [
                        {
                            label: 'Projection',
                            data: [43, 127, 220, 313, 353],
                            borderColor: '#3498db',
                            backgroundColor: 'rgba(52, 152, 219, 0.1)',
                            fill: true
                        },
                        {
                            label: 'Attainment',
                            data: [39, 105, 225, 330, 367],
                            borderColor: '#27ae60',
                            backgroundColor: 'rgba(39, 174, 96, 0.1)',
                            fill: true
                        }
                    ]
                }
            });

            // Performance Chart
            const perfCtx = document.getElementById('performanceChart').getContext('2d');
            new Chart(perfCtx, {
                type: 'bar',
                data: {
                    labels: Object.keys(storeData.projection),
                    datasets: [
                        {
                            label: 'Projected',
                            data: Object.values(storeData.projection).map(s => sumFirstNHours(s, 5)),
                            backgroundColor: '#3498db'
                        },
                        {
                            label: 'Attained',
                            data: Object.values(storeData.attainment).map(s => sumFirstNHours(s, 5)),
                            backgroundColor: '#27ae60'
                        }
                    ]
                }
            });
        }

        function populateTable() {
            const tbody = document.getElementById('storesTable');
            tbody.innerHTML = '';

            Object.keys(storeData.projection).forEach(store => {
                const attainment = storeData.attainment[store];
                const projected = sumFirstNHours(storeData.projection[store], 5);
                const attained = sumFirstNHours(attainment, 5);
                const achievement = ((attained / projected) * 100).toFixed(1);
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="store-name">${store}</td>
                    <td>${attainment[6] || '-'}</td>
                    <td>${attainment[7] || '-'}</td>
                    <td>${attainment[8] || '-'}</td>
                    <td>${attainment[9] || '-'}</td>
                    <td>${attainment[10] || '-'}</td>
                    <td><strong>${attained}</strong></td>
                    <td>
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <div class="progress-bar" style="flex: 1;">
                                <div class="progress-fill" style="width: ${Math.min(achievement, 100)}%; background: ${achievement >= 90 ? '#27ae60' : achievement >= 70 ? '#f39c12' : '#e74c3c'}"></div>
                            </div>
                            <span>${achievement}%</span>
                        </div>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        function showLoading() {
            document.getElementById('loading').style.display = 'block';
            document.getElementById('content').style.display = 'none';
        }

        function hideLoading() {
            document.getElementById('loading').style.display = 'none';
            document.getElementById('content').style.display = 'block';
        }

        // Load data when page loads
        document.addEventListener('DOMContentLoaded', loadData);
    </script>
</body>
</html>
